# Anchor Checker — проверка анкоров и ссылок

Скрипт проверяет по списку страниц: есть ли на каждой странице ссылка с заданным анкором (Exact Anchor) на заданный URL (Target URL). Результат записывается в колонку **Found** (Yes / No / Error).

Колонки таблицы:
- **Page URL** — страница, которую проверяем
- **Target URL** — URL, на который должна вести ссылка
- **Exact Anchor** — точный текст ссылки (анкор)
- **Found** — результат: Yes / No / Error (заполняет скрипт)

---

## Задача «сделать через ассистента» (Cursor)

Проверку можно делать **через меня**: ты даёшь данные или ссылку на таблицу — я запускаю проверку и возвращаю результат (или записываю его в Google Таблицу).

### Способ А: Данные в проекте или в чате

1. Положи в папку проекта файл **`anchors.csv`** с колонками **Page URL**, **Target URL**, **Exact Anchor** (колонку Found можно оставить пустой).  
   Или вставь в чат таблицу (те же три колонки).
2. Напиши: **«Проверь анкоры»** или **«Запусти проверку по anchors.csv»**.
3. Я запущу скрипт проверки и выведу результат (Yes/No/Error по строкам) или обновлю файл `anchors.csv` — колонку **Found** можно будет скопировать в Google Таблицу.

### Способ Б: Прямо в Google Таблице — **без Cloud Console**

Ты один раз настраиваешь скрипт в таблице и разворачиваешь его как **веб-приложение**. Дальше в чате даёшь мне **URL веб-приложения** — я вызываю его, скрипт срабатывает и заполняет колонку **Found** в этой же таблице. Никакого Google Cloud и ключей.

**Шаги (один раз):**

1. Открой свою Google Таблицу с колонками **Page URL**, **Target URL**, **Exact Anchor**.
2. **Расширения → Apps Script** — вставь код из **`apps_script/Code.gs`** (из этого проекта), сохрани.
3. В редакторе Apps Script нажми **Развернуть → Новое развёртывание**.
4. Тип: **Веб-приложение**. Настройки:
   - **Выполнять от имени**: я (твой аккаунт)
   - **У кого есть доступ**: «Только я» или «Все, у кого есть ссылка» (ссылку храни в секрете — кто знает URL, тот может запустить проверку).
5. Нажми **Развернуть**, скопируй **URL веб-приложения** (вид: `https://script.google.com/macros/s/.../exec`).

**Дальше в работе:**

- В чате пишешь: **«Проверь анкоры в таблице»** и прикладываешь или вставляешь этот URL (или сохраняешь его в файле в проекте, например `webapp_url.txt`).
- Я открываю этот URL (или запускаю запрос к нему) — скрипт выполняется в твоей таблице и заполняет колонку **Found**.

Важно: скрипт привязан к **той таблице, в которой он создан**. Данные для проверки должны быть в этой же таблице. URL веб-приложения лучше никому не передавать — тот, у кого он есть, может запускать проверку от твоего имени.

**Чтобы я проверял новые строки автоматически по твоей команде:** сохрани URL веб-приложения в файл **`webapp_url.txt`** в этом проекте (одна строка с `https://script.google.com/.../exec`). Когда ты пишешь в чате **«Проверь анкоры»**, я читаю этот файл, вызываю URL — скрипт проверяет все строки (включая новые) и заполняет **Found**. Ссылку вставлять каждый раз не нужно.

---

## Как сделать автоматическую проверку новых строк

### Вариант 1: По расписанию в самой таблице (полная автоматика)

В таблице уже есть меню **Анкоры**. Один раз выбери **Анкоры → Включить автопроверку раз в день**. Скрипт будет запускаться **каждый день в 9:00** (по часовому поясу таблицы), проверять все строки, включая новые, и заполнять колонку **Found**. Ничего нажимать и писать не нужно.

Чтобы отключить: **Анкоры → Отключить автопроверку**.

### Вариант 2: По команде в чате (полуавтомат)

1. Разверни скрипт как веб-приложение (см. Способ Б выше), скопируй URL.
2. Открой в проекте файл **`webapp_url.txt`** и вставь этот URL на строку с `https://...` (замени заглушку).
3. Когда в таблице появились новые строки, напиши в чате: **«Проверь анкоры»**. Я прочитаю URL из `webapp_url.txt`, вызову его — скрипт проверит все строки (включая новые) и заполнит **Found**.

---

### Способ В: Прямо в Google Таблице через Python (нужен Cloud Console)

1. Один раз настраиваешь доступ через Google Cloud (сервисный аккаунт + ключ `service_account.json` в проекте), как в **Варианте 2** ниже.
2. В чате даёшь ссылку на таблицу и пишешь: **«Проверь анкоры в этой таблице»**.
3. Я запускаю скрипт `check_anchors_gsheet.py` — результат появляется в колонке **Found**.

Итого: задача «сделать через тебя» = ты даёшь данные или URL (файла/таблицы/веб-приложения), я запускаю проверку и либо вывожу результат, либо заполняю Found в таблице.

---

## Вариант 1: Всё в Google Таблице — без Cloud Console и без Python

**Никаких ключей, сервисных аккаунтов и Google Cloud Console.** Скрипт живёт прямо в твоей таблице и запускается из неё.

### Шаги

1. Открой свою Google Таблицу с колонками **Page URL**, **Target URL**, **Exact Anchor** (колонку **Found** можно не создавать — появится сама).
2. В меню выбери **Расширения → Apps Script**.
3. Удали весь код в редакторе и вставь содержимое файла **`apps_script/Code.gs`** из этого проекта (или скопируй код ниже).
4. Нажми **Сохранить** (дискета). Название проекта можно оставить любым.
5. При первом запуске: в меню скрипта выбери функцию **`checkAnchors`** и нажми **Выполнить**. Разреши доступ к таблице («Проверить разрешения» → выбери свой аккаунт → «Дополнительные» → «Перейти на страницу…» → «Разрешить»).
6. Дальше можно не заходить в Apps Script: в самой таблице появится меню **Анкоры → Проверить анкоры**. Нажимаешь — скрипт проверяет все строки и заполняет колонку **Found**.

**Чтобы проверку запускал ассистент (Способ Б без Cloud Console):** в том же скрипте нажми **Развернуть → Новое развёртывание → Веб-приложение**, скопируй URL и передай его ассистенту. По запросу ассистент вызовет этот URL — скрипт выполнится и заполнит **Found** (подробнее в разделе «Способ Б» выше).

Код скрипта лежит в папке **`apps_script/Code.gs`** в этом репозитории. Скопируй его целиком в редактор Apps Script.

---

## Вариант 2: Python + Google Sheets API (нужен Cloud Console)

Скрипт на Python сам читает таблицу, проверяет страницы и записывает результат в колонку **Found**. Нужен сервисный аккаунт в Google Cloud.

### Шаг 1: Настройка Google Cloud (один раз)

1. Зайди в [Google Cloud Console](https://console.cloud.google.com/).
2. Создай проект или выбери существующий.
3. Включи API: **APIs & Services → Enable APIs and Services** → найди и включи **Google Sheets API** и **Google Drive API**.
4. Создай сервисный аккаунт: **APIs & Services → Credentials → Create Credentials → Service account**. Дай любое имя, нажми **Done**.
5. Открой созданный сервисный аккаунт → вкладка **Keys** → **Add Key → Create new key** → **JSON**. Скачается файл с ключом.
6. Переименуй файл в `service_account.json` и положи его в папку проекта `c:\project\anchor_checker\`.

### Шаг 2: Доступ к таблице

1. Открой скачанный `service_account.json` и скопируй значение поля **client_email** (вид: `xxx@project-id.iam.gserviceaccount.com`).
2. Открой свою Google Таблицу с колонками **Page URL**, **Target URL**, **Exact Anchor**, **Found**.
3. Нажми **Поделиться** и добавь этот email с правами **Редактор**. Сохрани.

### Шаг 3: Запуск

```bash
cd c:\project\anchor_checker
pip install -r requirements.txt
python check_anchors_gsheet.py "https://docs.google.com/spreadsheets/d/ТВОЙ_ID_ТАБЛИЦЫ/edit"
```

Вместо ссылки можно указать только ID таблицы (длинная строка из URL между `/d/` и `/edit`).  
Если ключ лежит не в папке проекта:

```bash
python check_anchors_gsheet.py "URL_таблицы" "C:\путь\к\service_account.json"
```

Если нужно проверить не первый лист, а лист с именем, например, «Проверка»:

```bash
python check_anchors_gsheet.py "URL_таблицы" "" "Проверка"
```

После запуска колонка **Found** в таблице заполнится значениями **Yes** / **No** / **Error**.

---

## Вариант 3: Через CSV (без Google API)

1. В Google Таблице сделай колонки: **Page URL**, **Target URL**, **Exact Anchor**, **Found**.
2. Скачай как CSV: **Файл → Скачать → CSV**. Сохрани как `anchors.csv` в папку проекта.
3. Запусти: `python check_anchors.py anchors.csv`
4. Открой обновлённый `anchors.csv` и скопируй колонку **Found** обратно в Google Таблицу при необходимости.

## Поведение

- Сравнение URL: учитываются trailing slash и схема (http/https); фрагмент `#anchor` отбрасывается.
- Сравнение анкора: лишние пробелы и переносы строк убираются.
- Между запросами к сайтам пауза 1 сек.
- При ошибке загрузки страницы в **Found** пишется **Error** (в консоли будет причина).

## Дашборд: ссылки по сотрудникам и проектам

В проекте есть веб-дашборд на Streamlit: размещения за период (неделя/месяц), разрез по сотрудникам и проектам, матрица сотрудник×проект.

**Запуск:** из корня проекта выполни `streamlit run app/dashboard/app.py`, затем открой в браузере указанный адрес (обычно http://localhost:8501).

Данные подтягиваются из четырёх Google Таблиц (если в проекте есть `service_account.json` с доступом к ним) или загружаются вручную CSV. Подробнее: **docs/DASHBOARD_README.md**.

---

## Файлы в проекте

- **apps_script/Code.gs** — скрипт для Google Таблицы (без Cloud Console): вставь в Расширения → Apps Script и запускай из меню «Анкоры».
- **check_anchors_gsheet.py** — проверка через Python + Google Sheets API (нужен service_account.json).
- **check_anchors.py** — проверка по CSV (вход/выход — файл).
- **app/dashboard/** — дашборд Streamlit (data_loader, aggregates, charts, app.py).
- **service_account.json** — ключ из Google Cloud для варианта 2 и для дашборда (не коммитить в git).
